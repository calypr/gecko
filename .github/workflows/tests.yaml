name: Go Tests

on: [ pull_request ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24.2'

    - name: Start PostgreSQL
      run: |
        docker rm -f gecko-postgres-test > /dev/null 2>&1 || true

        docker run -d \
          --name gecko-postgres-test \
          -p 8081:5432 \
          -e POSTGRES_PASSWORD=your_strong_password \
          -e POSTGRES_USER=postgres \
          postgres:10.4 > /dev/null

        # Wait for PostgreSQL to be ready
        for i in {1..30}; do
          if docker exec gecko-postgres-test pg_isready -U postgres -h localhost; then
            break
          fi
          sleep 1
        done

    - name: Setup Database
      run: |
        docker exec gecko-postgres-test psql -U postgres -c "CREATE DATABASE testdb;"

        docker exec gecko-postgres-test psql -U postgres -d testdb -c "
          DO \$\$
          BEGIN
              IF NOT EXISTS (SELECT 1 FROM pg_namespace WHERE nspname = 'config_schema') THEN
                  CREATE SCHEMA config_schema;
              END IF;
          END \$\$;

          CREATE OR REPLACE FUNCTION create_config_table(schema_name TEXT, table_name TEXT)
          RETURNS void AS \$\$
          BEGIN
              EXECUTE format('
                  CREATE TABLE IF NOT EXISTS %I.%I (
                      name VARCHAR(255) PRIMARY KEY,
                      content JSONB
                  );
              ', schema_name, table_name);
          END;
          \$\$ LANGUAGE plpgsql;

          DO \$\$
          DECLARE
              config_tables TEXT[] := ARRAY['explorer', 'footer', 'nav', 'file_summary', 'apps_page'];
              table_name TEXT;
          BEGIN
              FOREACH table_name IN ARRAY config_tables
              LOOP
                  PERFORM create_config_table('config_schema', table_name);
              END LOOP;
          END \$\$;

          DROP FUNCTION create_config_table(TEXT, TEXT);
        "
      env:
        PGPASSWORD: your_strong_password


    - name: Start Qdrant
      run: |
        docker rm -f gecko-qdrant-test > /dev/null 2>&1 || true

        docker run -d \
          --name gecko-qdrant-test \
          -p 6334:6334 \
          -e QDRANT__SERVICE__API_KEY=your_qdrant_api_key \
          qdrant/qdrant:latest > /dev/null

        # Wait for Qdrant to be ready
        for i in {1..30}; do
          if curl --silent --fail http://localhost:6334/readyz > /dev/null; then
            break
          fi
          sleep 1
        done


    - name: Run Tests
      run: |
        make
        ./bin/gecko \
          -db "postgresql://postgres:your_strong_password@localhost:8081/testdb?sslmode=disable" \
          -port 8080 \
          -qdrant-api-key "your_qdrant_api_key" \
          -qdrant-host localhost \
          -qdrant-port 6334 &
        # Wait for application to be ready
        for i in {1..30}; do
          if curl --silent --fail http://localhost:8080/health > /dev/null; then
            break
          fi
          sleep 1
        done
        go test -v ./...
